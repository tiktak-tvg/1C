&НаСервереБезКонтекста
Процедура ЗаполнитьСубконтоНаСервере()
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ПроводкиОборотыДтКт.Регистратор
		|ИЗ
		|	РегистрБухгалтерии.Проводки.ОборотыДтКт(, , Регистратор, СчетДт = ЗНАЧЕНИЕ(ПланСчетов.Бухгалтерский.Капитал), , СчетКт = ЗНАЧЕНИЕ(ПланСчетов.Бухгалтерский.Товары), , ) КАК ПроводкиОборотыДтКт";
	Результат = Запрос.Выполнить();
	РегистрыБухгалтерии.Проводки.УстановитьИспользованиеИтогов(Ложь);
	// Теперь нельзя обращаться к виртуальным таблицам
	Выборка = Результат.Выбрать();
	ТекНоменклатура = Неопределено;
	
	Пока Выборка.Следующий() Цикл
		ДокументСсылка = Выборка.Регистратор;
		Проводки = РегистрыБухгалтерии.Проводки.СоздатьНаборЗаписей();
		Проводки.Отбор.Регистратор.Установить(ДокументСсылка);
		Проводки.Прочитать();
		
		Для Каждого Проводка Из Проводки Цикл
			Если Проводка.СчетДт = ПланыСчетов.Бухгалтерский.Капитал
				И Проводка.СчетКт = ПланыСчетов.Бухгалтерский.Товары Тогда
				ТекНоменклатура = Проводка.СубконтоКт.Номенклатура;
				Проводка.СубконтоДт.Номенклатура = ТекНоменклатура;
			КонецЕсли;
			
			Если Проводка.СчетДт = ПланыСчетов.Бухгалтерский.Покупатели
				И Проводка.СчетКт = ПланыСчетов.Бухгалтерский.Капитал Тогда
				Проводка.СубконтоКт.Номенклатура = ТекНоменклатура;
			КонецЕсли;
		КонецЦикла;
		
		Если Проводки.Модифицированность() Тогда
			Проводки.Записать();
		КонецЕсли;
	КонецЦикла;
	
	РегистрыБухгалтерии.Проводки.УстановитьИспользованиеИтогов(Истина);
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьСубконто(Команда)
	ЗаполнитьСубконтоНаСервере();
КонецПроцедуры
